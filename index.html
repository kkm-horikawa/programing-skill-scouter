<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Scouter - Advanced Analysis</title>
    <style>
        body {
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            flex-direction: column;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
        }
        .input-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        input {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            margin-right: 10px;
            font-family: 'Orbitron', monospace;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background: #00ff00;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        button:disabled {
            background: #888;
            cursor: not-allowed;
        }
        .error {
            color: #ff0000;
            margin-top: 10px;
            font-family: 'Orbitron', monospace;
        }
        .loading {
            color: #00ff00;
            margin-top: 10px;
            font-family: 'Orbitron', monospace;
            font-size: 12px;
        }
        .token-section {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 12px;
        }
        .token-input {
            width: 300px;
            font-size: 12px;
            padding: 8px;
        }
        .token-button {
            padding: 8px 15px;
            font-size: 12px;
            background: #4CAF50;
            margin-left: 5px;
        }
        .token-status {
            font-family: 'Orbitron', monospace;
            font-size: 10px;
            margin-top: 5px;
        }
        .token-saved {
            color: #4CAF50;
        }
        .token-info {
            color: #666;
            font-size: 11px;
            margin-top: 5px;
        }
        .detail-button {
            padding: 10px 20px;
            font-size: 14px;
            background: #0066cc;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }
        .detail-button:hover {
            background: #0052a3;
        }
        
        /* 履歴書モーダル */
        .resume-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow: auto;
        }
        
        .resume-content {
            background-color: white;
            margin: 20px auto;
            padding: 0;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            font-family: 'Noto Sans JP', 'ヒラギノ角ゴ Pro', 'Hiragino Kaku Gothic Pro', 'メイリオ', sans-serif;
        }
        
        .resume-header {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            border-bottom: 2px solid #ddd;
        }
        
        .resume-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .resume-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .resume-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #0066cc;
        }
        
        .tech-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .tech-category {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .tech-category-title {
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .tech-item {
            font-size: 12px;
            line-height: 1.6;
            color: #555;
        }
        
        .skill-badge {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .proficiency-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .proficiency-fill {
            height: 100%;
            background: #4caf50;
            transition: width 1s ease;
        }
        
        .close-button {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        
        .close-button:hover {
            color: #333;
        }
        
        .resume-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-box {
            text-align: center;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #0066cc;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="input-container">
        <h2 style="font-family: 'Orbitron', monospace; color: #00ff00;" id="title">GitHub Power Scouter</h2>
        <input type="text" id="username" placeholder="GitHub Username" value="torvalds">
        <button id="scanButton" onclick="scanUser()">SCAN</button>
        <div id="error" class="error"></div>
        <div id="loading" class="loading"></div>
        
        <div class="token-section">
            <div style="font-family: 'Orbitron', monospace; color: #00aa00; margin-bottom: 10px;">GITHUB TOKEN SETTINGS</div>
            <input type="password" id="tokenInput" class="token-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
            <button class="token-button" onclick="saveToken()">SAVE</button>
            <button class="token-button" style="background: #ff6b6b;" onclick="clearToken()">CLEAR</button>
            <div id="tokenStatus" class="token-status"></div>
            <div class="token-info">
                <a href="https://github.com/settings/tokens/new?scopes=public_repo,read:user" target="_blank" style="color: #00aa00;">Generate token →</a>
                | Increases API limit from 60 to 5,000 requests/hour
            </div>
    
    <button id="detailButton" class="detail-button" onclick="showDetailResume()">技術履歴書を表示 / Show Tech Resume</button>
    
    <!-- 履歴書モーダル -->
    <div id="resumeModal" class="resume-modal">
        <div class="resume-content">
            <div class="resume-header">
                <span class="close-button" onclick="closeResume()">&times;</span>
                <h2 class="resume-title">技術スキル履歴書 / Technical Skills Resume</h2>
                <div id="resumeUserInfo" style="text-align: center; margin-top: 10px;"></div>
            </div>
            
            <div class="resume-section">
                <h3 class="section-title">プログラミング言語 / Programming Languages</h3>
                <div id="languageSkills" class="tech-grid"></div>
            </div>
            
            <div class="resume-section">
                <h3 class="section-title">技術スタック / Technology Stack</h3>
                <div id="techStack" class="tech-grid"></div>
            </div>
            
            <div class="resume-section">
                <h3 class="section-title">フレームワーク・ライブラリ / Frameworks & Libraries</h3>
                <div id="frameworkSkills"></div>
            </div>
            
            <div class="resume-section">
                <h3 class="section-title">開発実績 / Development Achievements</h3>
                <div id="achievements" class="resume-stats"></div>
            </div>
            
            <div class="resume-section">
                <h3 class="section-title">OSS貢献 / OSS Contributions</h3>
                <div id="ossContributions"></div>
            </div>
        </div>
    </div>
        </div>
    </div>
    
    <div class="container">
        <svg width="500" height="300" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <!-- グロー効果 -->
                <filter id="glow">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
                
                <!-- スキャンライン効果 -->
                <linearGradient id="scanline" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#00ff00;stop-opacity:0" />
                    <stop offset="50%" style="stop-color:#00ff00;stop-opacity:0.5" />
                    <stop offset="100%" style="stop-color:#00ff00;stop-opacity:0" />
                    <animate attributeName="y1" values="-100%;200%" dur="2s" repeatCount="indefinite" />
                    <animate attributeName="y2" values="0%;300%" dur="2s" repeatCount="indefinite" />
                </linearGradient>
            </defs>
            
            <style>
                .scouter-text {
                    font-family: 'Orbitron', monospace;
                    font-weight: 700;
                    fill: #00ff00;
                    filter: url(#glow);
                }
                
                .power-level {
                    font-size: 36px;
                    transition: all 0.3s ease;
                }
                
                .label {
                    font-size: 14px;
                    fill: #00cc00;
                }
                
                .small-label {
                    font-size: 9px;
                    fill: #00aa00;
                }
                
                .frame {
                    fill: none;
                    stroke: #00ff00;
                    stroke-width: 2;
                    filter: url(#glow);
                    animation: pulse 2s ease-in-out infinite;
                }
                
                @keyframes pulse {
                    0%, 100% { opacity: 0.8; }
                    50% { opacity: 1; }
                }
                
                .inner-frame {
                    fill: rgba(0, 255, 0, 0.05);
                    stroke: #00ff00;
                    stroke-width: 1;
                    stroke-dasharray: 5, 5;
                    animation: rotate-dash 20s linear infinite;
                }
                
                @keyframes rotate-dash {
                    to { stroke-dashoffset: 60; }
                }
                
                .scan-line {
                    fill: url(#scanline);
                    opacity: 0.3;
                }
                
                .status-dot {
                    fill: #00ff00;
                    animation: blink-dot 1s ease-in-out infinite;
                }
                
                @keyframes blink-dot {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.3; }
                }
                
                .complete-msg {
                    fill: #00ff00;
                    font-size: 12px;
                    opacity: 0;
                    transition: opacity 0.5s ease;
                }
                
                .rank {
                    fill: #ffff00;
                    font-size: 14px;
                    opacity: 0;
                    transition: opacity 0.5s ease;
                }
                
                .stats-group {
                    opacity: 0;
                    transition: opacity 0.5s ease;
                }
                
                .power-level.counting {
                    filter: url(#glow) blur(0.5px);
                }
                
                .username {
                    fill: #00ffff;
                    font-size: 16px;
                    opacity: 0;
                    transition: opacity 0.5s ease;
                }
                
                .detail-stats {
                    opacity: 0;
                    transition: opacity 0.5s ease;
                }
                
                .progress-bar {
                    stroke: #00ff00;
                    stroke-width: 2;
                    fill: none;
                    stroke-linecap: round;
                }
                
                .progress-fill {
                    stroke: #00ff00;
                    stroke-width: 2;
                    fill: none;
                    stroke-linecap: round;
                    filter: url(#glow);
                    stroke-dasharray: 100;
                    stroke-dashoffset: 100;
                    transition: stroke-dashoffset 1s ease;
                }
            </style>
            
            <!-- 背景 -->
            <rect width="500" height="300" fill="#000000" rx="10"/>
            
            <!-- 外枠 -->
            <rect x="10" y="10" width="480" height="280" class="frame" rx="5"/>
            
            <!-- 内枠 -->
            <rect x="20" y="20" width="460" height="260" class="inner-frame" rx="3"/>
            
            <!-- スキャンライン効果 -->
            <rect x="20" y="20" width="460" height="260" class="scan-line"/>
            
            <!-- ユーザー名 -->
            <text x="30" y="40" id="targetUser" class="username scouter-text">TARGET: </text>
            
            <!-- ステータステキスト -->
            <text x="30" y="65" id="scanStatus" class="label scouter-text">SCANNING TARGET...</text>
            
            <!-- 戦闘力ラベル -->
            <text x="30" y="105" class="label scouter-text">POWER LEVEL:</text>
            
            <!-- 戦闘力数値 -->
            <text x="30" y="145" id="powerLevel" class="power-level scouter-text">0</text>
            
            <!-- 完了メッセージ -->
            <text x="30" y="175" id="completeMsg" class="complete-msg scouter-text">SCAN COMPLETE</text>
            
            <!-- ランク表示 -->
            <text x="30" y="205" id="rank" class="rank scouter-text">RANK: CALCULATING...</text>
            
            <!-- 基本ステータス表示 -->
            <g id="statsGroup" class="stats-group">
                <text x="280" y="65" class="label scouter-text" font-size="10">BASIC STATS</text>
                <text x="280" y="80" id="repoStat" class="small-label scouter-text">REPOS: -</text>
                <text x="280" y="95" id="starStat" class="small-label scouter-text">STARS: -</text>
                <text x="280" y="110" id="followerStat" class="small-label scouter-text">FOLLOWERS: -</text>
                <text x="280" y="125" id="yearStat" class="small-label scouter-text">ACCOUNT AGE: -</text>
                
                <text x="380" y="65" class="label scouter-text" font-size="10">ACTIVITY</text>
                <text x="380" y="80" id="commitStat" class="small-label scouter-text">COMMITS: -</text>
                <text x="380" y="95" id="prStat" class="small-label scouter-text">PULL REQS: -</text>
                <text x="380" y="110" id="issueStat" class="small-label scouter-text">ISSUES: -</text>
                <text x="380" y="125" id="contributionStat" class="small-label scouter-text">CONTRIB: -</text>
            </g>
            
            <!-- 詳細ステータス -->
            <g id="detailStats" class="detail-stats">
                <text x="30" y="235" class="label scouter-text" font-size="10">LANGUAGE PROFICIENCY</text>
                <text x="30" y="250" id="langStat1" class="small-label scouter-text">-</text>
                <text x="130" y="250" id="langStat2" class="small-label scouter-text">-</text>
                <text x="230" y="250" id="langStat3" class="small-label scouter-text">-</text>
                
                <text x="30" y="270" class="label scouter-text" font-size="10">SPECIAL ABILITIES</text>
                <text x="150" y="270" id="specialAbility" class="small-label scouter-text" style="fill: #ffff00">-</text>
            </g>
            
            <!-- ステータスインジケータ -->
            <circle cx="470" cy="30" r="5" class="status-dot"/>
            <text x="445" y="35" class="label scouter-text" font-size="8">ONLINE</text>
            
            <!-- プログレスバー -->
            <g id="progressGroup" style="opacity: 0">
                <text x="280" y="155" class="small-label scouter-text">SCAN PROGRESS</text>
                <rect x="280" y="160" width="100" height="5" class="progress-bar" rx="2"/>
                <rect x="280" y="160" width="100" height="5" class="progress-fill" rx="2" id="progressBar"/>
            </g>
        </svg>
    </div>
    
    <script>
        let currentAnimation = null;
        
        // 詳細な技術分析データを保存
        let detailedTechData = null;
        
        // ファイル拡張子から技術スタックを推定
        async function analyzeTechStack(repos) {
            const techStack = {
                languages: {},
                frameworks: new Set(),
                devops: new Set(),
                testing: new Set(),
                databases: new Set(),
                infrastructure: new Set()
            };
            
            // 各リポジトリのファイル構造を分析（上位20リポジトリ）
            const topRepos = repos.slice(0, 20);
            
            for (const repo of topRepos) {
                try {
                    const headers = getHeaders();
                    // リポジトリのルートコンテンツを取得
                    const contentsResponse = await fetch(`https://api.github.com/repos/${repo.full_name}/contents`, { headers });
                    if (contentsResponse.ok) {
                        const contents = await contentsResponse.json();
                        
                        for (const item of contents) {
                            const fileName = item.name.toLowerCase();
                            
                            // 設定ファイルから技術を推定
                            if (fileName === 'package.json') {
                                techStack.frameworks.add('Node.js/npm');
                                // package.jsonの内容を取得して詳細分析
                                await analyzePackageJson(repo.full_name, techStack);
                            } else if (fileName === 'requirements.txt' || fileName === 'pipfile') {
                                techStack.frameworks.add('Python');
                            } else if (fileName === 'pyproject.toml') {
                                techStack.frameworks.add('Python (Modern)');
                            } else if (fileName === 'composer.json') {
                                techStack.frameworks.add('PHP/Composer');
                            } else if (fileName === 'pom.xml') {
                                techStack.frameworks.add('Java/Maven');
                            } else if (fileName === 'build.gradle') {
                                techStack.frameworks.add('Java/Gradle');
                            } else if (fileName === 'cargo.toml') {
                                techStack.frameworks.add('Rust');
                            } else if (fileName === 'go.mod') {
                                techStack.frameworks.add('Go');
                            } else if (fileName === 'gemfile') {
                                techStack.frameworks.add('Ruby');
                            }
                            
                            // DevOps/インフラ
                            if (fileName === 'dockerfile' || fileName.includes('docker')) {
                                techStack.devops.add('Docker');
                            }
                            if (fileName.endsWith('.yml') || fileName.endsWith('.yaml')) {
                                if (fileName.includes('github')) {
                                    techStack.devops.add('GitHub Actions');
                                } else if (fileName.includes('gitlab')) {
                                    techStack.devops.add('GitLab CI');
                                } else if (fileName.includes('circle')) {
                                    techStack.devops.add('CircleCI');
                                }
                            }
                            if (fileName.endsWith('.tf')) {
                                techStack.infrastructure.add('Terraform');
                            }
                            if (fileName === 'kubernetes.yml' || fileName.includes('k8s')) {
                                techStack.infrastructure.add('Kubernetes');
                            }
                            
                            // テスト
                            if (item.type === 'dir' && (item.name === 'test' || item.name === 'tests' || item.name === 'spec' || item.name === '__tests__')) {
                                techStack.testing.add('Test-Driven Development');
                            }
                            if (fileName === 'jest.config.js') {
                                techStack.testing.add('Jest');
                            }
                            if (fileName === 'cypress.json') {
                                techStack.testing.add('Cypress');
                            }
                            
                            // データベース
                            if (fileName.includes('mongo')) {
                                techStack.databases.add('MongoDB');
                            }
                            if (fileName.includes('postgres') || fileName.includes('pg')) {
                                techStack.databases.add('PostgreSQL');
                            }
                            if (fileName.includes('mysql')) {
                                techStack.databases.add('MySQL');
                            }
                            if (fileName.includes('redis')) {
                                techStack.databases.add('Redis');
                            }
                        }
                    }
                } catch (e) {
                    console.error('Tech stack analysis error:', e);
                }
            }
            
            return techStack;
        }
        
        // package.jsonの詳細分析
        async function analyzePackageJson(repoFullName, techStack) {
            try {
                const headers = getHeaders();
                const response = await fetch(`https://api.github.com/repos/${repoFullName}/contents/package.json`, { headers });
                if (response.ok) {
                    const data = await response.json();
                    const content = JSON.parse(atob(data.content));
                    
                    // 依存関係から主要なフレームワークを検出
                    const allDeps = { ...content.dependencies, ...content.devDependencies };
                    
                    // フレームワーク検出
                    if (allDeps['react']) techStack.frameworks.add('React');
                    if (allDeps['vue']) techStack.frameworks.add('Vue.js');
                    if (allDeps['@angular/core']) techStack.frameworks.add('Angular');
                    if (allDeps['next']) techStack.frameworks.add('Next.js');
                    if (allDeps['nuxt']) techStack.frameworks.add('Nuxt.js');
                    if (allDeps['express']) techStack.frameworks.add('Express.js');
                    if (allDeps['fastify']) techStack.frameworks.add('Fastify');
                    if (allDeps['nestjs']) techStack.frameworks.add('NestJS');
                    
                    // テストツール
                    if (allDeps['jest']) techStack.testing.add('Jest');
                    if (allDeps['mocha']) techStack.testing.add('Mocha');
                    if (allDeps['cypress']) techStack.testing.add('Cypress');
                    if (allDeps['playwright']) techStack.testing.add('Playwright');
                    
                    // ビルドツール
                    if (allDeps['webpack']) techStack.devops.add('Webpack');
                    if (allDeps['vite']) techStack.devops.add('Vite');
                    if (allDeps['rollup']) techStack.devops.add('Rollup');
                    if (allDeps['esbuild']) techStack.devops.add('ESBuild');
                }
            } catch (e) {
                console.error('Package.json analysis error:', e);
            }
        }
        
        // 履歴書表示
        function showDetailResume() {
            if (!detailedTechData) return;
            
            const modal = document.getElementById('resumeModal');
            modal.style.display = 'block';
            
            // ユーザー情報
            const userInfo = document.getElementById('resumeUserInfo');
            userInfo.innerHTML = `
                <h3 style="margin: 0;">${detailedTechData.username}</h3>
                <p style="margin: 5px 0; color: #666;">Power Level: ${detailedTechData.powerLevel.toLocaleString()}</p>
            `;
            
            // プログラミング言語
            const languageSkills = document.getElementById('languageSkills');
            languageSkills.innerHTML = '';
            detailedTechData.languages.forEach(lang => {
                const div = document.createElement('div');
                div.className = 'tech-category';
                div.innerHTML = `
                    <div class="tech-category-title">${lang.name}</div>
                    <div class="proficiency-bar">
                        <div class="proficiency-fill" style="width: ${lang.percentage}%"></div>
                    </div>
                    <div class="tech-item">${lang.percentage}% of code</div>
                `;
                languageSkills.appendChild(div);
            });
            
            // 技術スタック
            const techStackDiv = document.getElementById('techStack');
            techStackDiv.innerHTML = '';
            
            const categories = [
                { title: 'DevOps & CI/CD', items: Array.from(detailedTechData.techStack.devops) },
                { title: 'Testing', items: Array.from(detailedTechData.techStack.testing) },
                { title: 'Infrastructure', items: Array.from(detailedTechData.techStack.infrastructure) },
                { title: 'Databases', items: Array.from(detailedTechData.techStack.databases) }
            ];
            
            categories.forEach(category => {
                if (category.items.length > 0) {
                    const div = document.createElement('div');
                    div.className = 'tech-category';
                    div.innerHTML = `
                        <div class="tech-category-title">${category.title}</div>
                        ${category.items.map(item => `<span class="skill-badge">${item}</span>`).join('')}
                    `;
                    techStackDiv.appendChild(div);
                }
            });
            
            // フレームワーク
            const frameworksDiv = document.getElementById('frameworkSkills');
            const frameworks = Array.from(detailedTechData.techStack.frameworks);
            frameworksDiv.innerHTML = frameworks.map(fw => `<span class="skill-badge" style="margin: 5px;">${fw}</span>`).join('');
            
            // 開発実績
            const achievements = document.getElementById('achievements');
            achievements.innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${detailedTechData.stats.repos}</div>
                    <div class="stat-label">Repositories</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${detailedTechData.stats.stars.toLocaleString()}</div>
                    <div class="stat-label">Total Stars</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${detailedTechData.stats.contributions}</div>
                    <div class="stat-label">Contributions (30d)</div>
                </div>
            `;
            
            // アニメーション
            setTimeout(() => {
                document.querySelectorAll('.proficiency-fill').forEach(bar => {
                    bar.style.width = bar.style.width;
                });
            }, 100);
        }
        
        // モーダルを閉じる
        function closeResume() {
            document.getElementById('resumeModal').style.display = 'none';
        }
        
        // モーダルの外側クリックで閉じる
        window.onclick = function(event) {
            const modal = document.getElementById('resumeModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // トークン管理
        let githubToken = localStorage.getItem('github_token') || '';
        
        function saveToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) {
                document.getElementById('tokenStatus').textContent = isJapanese ? 'トークンを入力してください' : 'Please enter a token';
                document.getElementById('tokenStatus').className = 'token-status error';
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                document.getElementById('tokenStatus').textContent = isJapanese ? '無効なトークン形式です' : 'Invalid token format';
                document.getElementById('tokenStatus').className = 'token-status error';
                return;
            }
            
            localStorage.setItem('github_token', token);
            githubToken = token;
            document.getElementById('tokenStatus').textContent = isJapanese ? 'トークンを保存しました' : 'Token saved successfully';
            document.getElementById('tokenStatus').className = 'token-status token-saved';
            
            // 入力欄をクリア（セキュリティのため）
            document.getElementById('tokenInput').value = '';
            
            // レート制限を再チェック
            checkRateLimit();
        }
        
        function clearToken() {
            localStorage.removeItem('github_token');
            githubToken = '';
            document.getElementById('tokenInput').value = '';
            document.getElementById('tokenStatus').textContent = isJapanese ? 'トークンを削除しました' : 'Token cleared';
            document.getElementById('tokenStatus').className = 'token-status';
            checkRateLimit();
        }
        
        // APIリクエスト用のヘッダーを取得
        function getHeaders() {
            return githubToken ? { 'Authorization': `token ${githubToken}` } : {};
        }
        
        // 言語設定
        const browserLang = navigator.language || navigator.userLanguage;
        const isJapanese = browserLang.startsWith('ja');
        
        // 翻訳テキスト
        const translations = {
            ja: {
                title: 'GitHub パワースカウター',
                placeholder: 'GitHubユーザー名',
                scanButton: 'スキャン',
                errorUserNotFound: 'ユーザーが見つかりません',
                errorEnterUsername: 'ユーザー名を入力してください',
                initScanner: 'スキャナーを初期化中...',
                analyzingRepos: 'リポジトリを分析中...',
                scanningLang: '言語能力を測定中...',
                measuringActivity: '最近の活動を測定中...',
                analysisComplete: '分析完了！',
                scanningTarget: 'ターゲットをスキャン中...',
                scanComplete: 'スキャン完了',
                // ランクは英語のまま
                ranks: {
                    legendary: "LEGENDARY DEVELOPER",
                    superElite: "SUPER ELITE",
                    elite: "ELITE DEVELOPER",
                    senior: "SENIOR DEVELOPER",
                    developer: "DEVELOPER",
                    junior: "JUNIOR DEVELOPER",
                    beginner: "BEGINNER"
                },
                // 特殊能力も英語のまま
                abilities: {
                    starCollector: "STAR COLLECTOR",
                    influencer: "INFLUENCER",
                    master: "MASTER",
                    hyperActive: "HYPER ACTIVE",
                    prolific: "PROLIFIC CREATOR",
                    veteran: "VETERAN",
                    gistWizard: "GIST WIZARD",
                    rising: "RISING TALENT"
                }
            },
            en: {
                title: 'GitHub Power Scouter',
                placeholder: 'GitHub Username',
                scanButton: 'SCAN',
                errorUserNotFound: 'User not found',
                errorEnterUsername: 'Please enter a username',
                initScanner: 'Initializing scanner...',
                analyzingRepos: 'Analyzing repositories...',
                scanningLang: 'Scanning language proficiency...',
                measuringActivity: 'Measuring recent activity...',
                analysisComplete: 'Analysis complete!',
                scanningTarget: 'SCANNING TARGET...',
                scanComplete: 'SCAN COMPLETE',
                ranks: {
                    legendary: "LEGENDARY DEVELOPER",
                    superElite: "SUPER ELITE",
                    elite: "ELITE DEVELOPER",
                    senior: "SENIOR DEVELOPER",
                    developer: "DEVELOPER",
                    junior: "JUNIOR DEVELOPER",
                    beginner: "BEGINNER"
                },
                abilities: {
                    starCollector: "STAR COLLECTOR",
                    influencer: "INFLUENCER",
                    master: "MASTER",
                    hyperActive: "HYPER ACTIVE",
                    prolific: "PROLIFIC CREATOR",
                    veteran: "VETERAN",
                    gistWizard: "GIST WIZARD",
                    rising: "RISING TALENT"
                }
            }
        };
        
        // 現在の言語設定を取得
        const t = isJapanese ? translations.ja : translations.en;
        
        // プログレスバーを更新
        function updateProgress(percent) {
            const bar = document.getElementById('progressBar');
            bar.style.strokeDashoffset = 100 - percent;
        }
        
        // カウンターアニメーション関数
        function animateCounter(element, target, duration) {
            const startTime = Date.now();
            let lastValue = 0;
            
            function update() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // イージング関数
                let easeProgress;
                if (progress < 0.1) {
                    easeProgress = progress * progress * 0.1;
                } else if (progress < 0.7) {
                    const adjustedProgress = (progress - 0.1) / 0.6;
                    easeProgress = 0.01 + (adjustedProgress * adjustedProgress * adjustedProgress) * 0.89;
                } else {
                    const adjustedProgress = (progress - 0.7) / 0.3;
                    easeProgress = 0.9 + (1 - Math.pow(1 - adjustedProgress, 3)) * 0.1;
                }
                
                const currentValue = Math.floor(target * easeProgress);
                
                // ランダムな変動を加える
                const randomVariation = Math.floor(Math.random() * 10) - 5;
                const displayValue = Math.max(0, currentValue + randomVariation);
                
                element.textContent = displayValue.toLocaleString();
                
                // 高速カウント時はブラー効果
                const speed = Math.abs(currentValue - lastValue);
                if (speed > 5000) {
                    element.classList.add('counting');
                } else {
                    element.classList.remove('counting');
                }
                
                lastValue = currentValue;
                
                if (progress < 1) {
                    currentAnimation = requestAnimationFrame(update);
                } else {
                    element.textContent = target.toLocaleString();
                    element.classList.remove('counting');
                    showCompleteStatus();
                }
            }
            
            update();
        }
        
        // 言語統計を取得
        async function getLanguageStats(username, repos) {
            const languages = {};
            let totalBytes = 0;
            
            // 各リポジトリの言語情報を取得（上位10リポジトリのみ）
            const topRepos = repos.slice(0, 10);
            for (const repo of topRepos) {
                try {
                    const headers = getHeaders();
                    const langResponse = await fetch(repo.languages_url, { headers });
                    if (langResponse.ok) {
                        const langData = await langResponse.json();
                        for (const [lang, bytes] of Object.entries(langData)) {
                            languages[lang] = (languages[lang] || 0) + bytes;
                            totalBytes += bytes;
                        }
                    }
                } catch (e) {
                    console.error('Language fetch error:', e);
                }
            }
            
            // 上位3言語を取得
            const sortedLangs = Object.entries(languages)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([lang, bytes]) => ({
                    name: lang,
                    percentage: Math.round((bytes / totalBytes) * 100)
                }));
            
            return sortedLangs;
        }
        
        // 最近のアクティビティを取得
        async function getRecentActivity(username) {
            let totalCommits = 0;
            let totalPRs = 0;
            let totalIssues = 0;
            let recentContributions = 0;
            
            try {
                // 最近のイベントを取得
                const headers = getHeaders();
                const eventsResponse = await fetch(`https://api.github.com/users/${username}/events/public?per_page=100`, { headers });
                if (eventsResponse.ok) {
                    const events = await eventsResponse.json();
                    
                    // 過去30日のアクティビティをカウント
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    events.forEach(event => {
                        const eventDate = new Date(event.created_at);
                        if (eventDate > thirtyDaysAgo) {
                            recentContributions++;
                            
                            switch(event.type) {
                                case 'PushEvent':
                                    totalCommits += event.payload.commits?.length || 0;
                                    break;
                                case 'PullRequestEvent':
                                    totalPRs++;
                                    break;
                                case 'IssuesEvent':
                                    totalIssues++;
                                    break;
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('Activity fetch error:', e);
            }
            
            return {
                commits: totalCommits,
                pullRequests: totalPRs,
                issues: totalIssues,
                recentContributions: recentContributions
            };
        }
        
        // 戦闘力を計算（詳細版）
        function calculatePowerLevel(userData, repoData, languageStats, activityData) {
            let totalStars = 0;
            let totalForks = 0;
            let totalWatchers = 0;
            let totalIssues = 0;
            let originalRepos = 0;
            
            repoData.forEach(repo => {
                totalStars += repo.stargazers_count;
                totalForks += repo.forks_count;
                totalWatchers += repo.watchers_count;
                totalIssues += repo.open_issues_count;
                if (!repo.fork) originalRepos++;
            });
            
            // アカウント年齢を計算
            const accountAge = new Date().getFullYear() - new Date(userData.created_at).getFullYear();
            
            // 戦闘力の計算式（より詳細に）
            const power = 
                (userData.public_repos * 100) +          // リポジトリ数
                (originalRepos * 200) +                  // オリジナルリポジトリボーナス
                (totalStars * 50) +                      // スター数
                (userData.followers * 30) +              // フォロワー数
                (userData.following * 5) +               // フォロー数（コミュニティ参加度）
                (totalForks * 40) +                      // フォーク数
                (totalWatchers * 20) +                   // ウォッチャー数
                (languageStats.length * 1000) +          // 使用言語の多様性
                (accountAge * 1000) +                    // アカウント年齢
                (userData.public_gists * 50) +           // Gist数
                (activityData.commits * 10) +            // 最近のコミット
                (activityData.pullRequests * 100) +      // 最近のPR
                (activityData.issues * 50) +             // 最近のイシュー
                (activityData.recentContributions * 20) + // 最近の活動
                (userData.bio ? 500 : 0) +               // プロフィール記入ボーナス
                (userData.blog ? 500 : 0) +              // ブログ記入ボーナス
                (userData.company ? 1000 : 0) +          // 会社情報ボーナス
                (userData.location ? 300 : 0) +          // 場所情報ボーナス
                (userData.hireable ? 2000 : 0);          // 採用可能ボーナス
            
            return {
                power: Math.floor(power),
                stats: {
                    repos: userData.public_repos,
                    originalRepos: originalRepos,
                    stars: totalStars,
                    forks: totalForks,
                    followers: userData.followers,
                    following: userData.following,
                    accountAge: accountAge,
                    languages: languageStats,
                    activity: activityData,
                    gists: userData.public_gists
                }
            };
        }
        
        // ランクを決定
        function determineRank(powerLevel) {
            const ranks = t.ranks;
            if (powerLevel >= 1000000) return ranks.legendary;
            if (powerLevel >= 500000) return ranks.superElite;
            if (powerLevel >= 100000) return ranks.elite;
            if (powerLevel >= 50000) return ranks.senior;
            if (powerLevel >= 10000) return ranks.developer;
            if (powerLevel >= 5000) return ranks.junior;
            return ranks.beginner;
        }
        
        // 特殊能力を判定
        function determineSpecialAbility(stats) {
            const abilities = t.abilities;
            if (stats.stars > 10000) return abilities.starCollector;
            if (stats.followers > 5000) return abilities.influencer;
            if (stats.languages.length > 0 && stats.languages[0].percentage > 80) return `${stats.languages[0].name} ${abilities.master}`;
            if (stats.activity.recentContributions > 50) return abilities.hyperActive;
            if (stats.originalRepos > 50) return abilities.prolific;
            if (stats.accountAge > 10) return abilities.veteran;
            if (stats.gists > 100) return abilities.gistWizard;
            return abilities.rising;
        }
        
        // 完了時の表示
        function showCompleteStatus() {
            setTimeout(() => {
                document.getElementById('completeMsg').style.opacity = '1';
            }, 100);
            
            setTimeout(() => {
                document.getElementById('rank').style.opacity = '1';
            }, 300);
            
            setTimeout(() => {
                document.getElementById('statsGroup').style.opacity = '1';
            }, 500);
            
            setTimeout(() => {
                document.getElementById('detailStats').style.opacity = '1';
            }, 700);
        }
        
        // リセット
        function resetDisplay() {
            if (currentAnimation) {
                cancelAnimationFrame(currentAnimation);
            }
            
            document.getElementById('powerLevel').textContent = '0';
            document.getElementById('completeMsg').style.opacity = '0';
            document.getElementById('rank').style.opacity = '0';
            document.getElementById('statsGroup').style.opacity = '0';
            document.getElementById('detailStats').style.opacity = '0';
            document.getElementById('targetUser').style.opacity = '0';
            document.getElementById('progressGroup').style.opacity = '0';
            document.getElementById('error').textContent = '';
            document.getElementById('loading').textContent = '';
            updateProgress(0);
        }
        
        // API制限チェック関数
        async function checkRateLimit() {
            try {
                const headers = getHeaders();
                const response = await fetch('https://api.github.com/rate_limit', { headers });
                const data = await response.json();
                const remaining = data.rate.remaining;
                const limit = data.rate.limit;
                const reset = new Date(data.rate.reset * 1000);
                
                const tokenStatusEl = document.getElementById('tokenStatus');
                if (githubToken) {
                    tokenStatusEl.textContent = isJapanese 
                        ? `認証済み: ${remaining}/${limit} 回 (${reset.toLocaleTimeString()}にリセット)`
                        : `Authenticated: ${remaining}/${limit} calls (resets at ${reset.toLocaleTimeString()})`;
                    tokenStatusEl.className = 'token-status token-saved';
                } else {
                    tokenStatusEl.textContent = isJapanese 
                        ? `未認証: ${remaining}/${limit} 回 (${reset.toLocaleTimeString()}にリセット)`
                        : `Unauthenticated: ${remaining}/${limit} calls (resets at ${reset.toLocaleTimeString()})`;
                    tokenStatusEl.className = 'token-status';
                }
                
                if (remaining < 10) {
                    const message = isJapanese 
                        ? `API残り回数: ${remaining}回。${reset.toLocaleTimeString()}にリセットされます。`
                        : `API calls remaining: ${remaining}. Resets at ${reset.toLocaleTimeString()}.`;
                    document.getElementById('error').textContent = message;
                }
                return remaining;
            } catch (e) {
                console.error('Rate limit check failed:', e);
                return null;
            }
        }
        
        // ユーザーをスキャン
        async function scanUser() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                document.getElementById('error').textContent = t.errorEnterUsername;
                return;
            }
            
            const scanButton = document.getElementById('scanButton');
            scanButton.disabled = true;
            resetDisplay();
            
            try {
                document.getElementById('progressGroup').style.opacity = '1';
                document.getElementById('loading').textContent = t.initScanner;
                updateProgress(10);
                
                // ユーザー情報を取得
                const headers = getHeaders();
                const userResponse = await fetch(`https://api.github.com/users/${username}`, { headers });
                if (!userResponse.ok) {
                    if (userResponse.status === 404) {
                        throw new Error(t.errorUserNotFound);
                    } else if (userResponse.status === 403) {
                        const rateLimitRemaining = userResponse.headers.get('X-RateLimit-Remaining');
                        if (rateLimitRemaining === '0') {
                            const resetTime = new Date(userResponse.headers.get('X-RateLimit-Reset') * 1000);
                            throw new Error(isJapanese 
                                ? `APIレート制限に達しました。${resetTime.toLocaleTimeString()}に再試行してください。` 
                                : `API rate limit exceeded. Please try again at ${resetTime.toLocaleTimeString()}.`);
                        }
                        throw new Error(isJapanese ? 'APIアクセスエラー' : 'API access error');
                    } else if (userResponse.status === 401) {
                        throw new Error(isJapanese ? '無効なトークンです' : 'Invalid token');
                    }
                    throw new Error(`${isJapanese ? 'エラー' : 'Error'}: ${userResponse.status}`);
                }
                const userData = await userResponse.json();
                updateProgress(30);
                
                document.getElementById('loading').textContent = t.analyzingRepos;
                
                // リポジトリ情報を取得（最大100件）
                const repoResponse = await fetch(`https://api.github.com/users/${username}/repos?per_page=100&sort=stars`, { headers });
                const repoData = await repoResponse.json();
                updateProgress(50);
                
                // 言語統計を取得
                document.getElementById('loading').textContent = t.scanningLang;
                const languageStats = await getLanguageStats(username, repoData);
                updateProgress(70);
                
                // 最近のアクティビティを取得
                document.getElementById('loading').textContent = t.measuringActivity;
                const activityData = await getRecentActivity(username);
                updateProgress(90);
                
                // 戦闘力を計算
                const result = calculatePowerLevel(userData, repoData, languageStats, activityData);
                updateProgress(100);
                
                document.getElementById('loading').textContent = t.analysisComplete;
                
                // 表示を更新
                document.getElementById('targetUser').textContent = `TARGET: ${username.toUpperCase()}`;
                document.getElementById('targetUser').style.opacity = '1';
                document.getElementById('scanStatus').textContent = 'ANALYSIS COMPLETE';
                
                // 統計情報を設定
                document.getElementById('repoStat').textContent = `REPOS: ${result.stats.repos} (${result.stats.originalRepos} ORIG)`;
                document.getElementById('starStat').textContent = `STARS: ${result.stats.stars.toLocaleString()}`;
                document.getElementById('followerStat').textContent = `FOLLOWERS: ${result.stats.followers.toLocaleString()}`;
                document.getElementById('yearStat').textContent = `ACCOUNT AGE: ${result.stats.accountAge}Y`;
                
                document.getElementById('commitStat').textContent = `COMMITS: ${result.stats.activity.commits}`;
                document.getElementById('prStat').textContent = `PULL REQS: ${result.stats.activity.pullRequests}`;
                document.getElementById('issueStat').textContent = `ISSUES: ${result.stats.activity.issues}`;
                document.getElementById('contributionStat').textContent = `30D ACT: ${result.stats.activity.recentContributions}`;
                
                // 言語統計
                result.stats.languages.forEach((lang, i) => {
                    const langElement = document.getElementById(`langStat${i + 1}`);
                    if (langElement) {
                        langElement.textContent = `${lang.name}: ${lang.percentage}%`;
                    }
                });
                
                // 特殊能力
                const specialAbility = determineSpecialAbility(result.stats);
                document.getElementById('specialAbility').textContent = specialAbility;
                
                // ランクを設定
                const rank = determineRank(result.power);
                document.getElementById('rank').textContent = `RANK: ${rank}`;
                
                // プログレスバーを非表示
                setTimeout(() => {
                    document.getElementById('progressGroup').style.opacity = '0';
                    document.getElementById('loading').textContent = '';
                }, 500);
                
                // カウンターアニメーション開始
                setTimeout(() => {
                    animateCounter(document.getElementById('powerLevel'), result.power, 3000);
                }, 1000);
                
            } catch (error) {
                console.error('Scan error:', error);
                document.getElementById('error').textContent = error.message;
                document.getElementById('loading').textContent = '';
                document.getElementById('progressGroup').style.opacity = '0';
                
                // レート制限をチェック
                checkRateLimit();
            } finally {
                scanButton.disabled = false;
            }
        }
        
        // Enterキーでスキャン実行
        document.getElementById('username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !document.getElementById('scanButton').disabled) {
                scanUser();
            }
        });
        
        // ページ読み込み時に言語を適用
        window.addEventListener('load', () => {
            // UIテキストを設定
            document.getElementById('title').textContent = t.title;
            document.getElementById('username').placeholder = t.placeholder;
            document.getElementById('scanButton').textContent = t.scanButton;
            document.getElementById('scanStatus').textContent = t.scanningTarget;
            document.getElementById('completeMsg').textContent = t.scanComplete;
            
            // レート制限を確認
            checkRateLimit();
            
            // デフォルトでスキャン
            setTimeout(scanUser, 500);
        });
    </script>
</body>
</html>